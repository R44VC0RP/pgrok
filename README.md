# pgrok

Personal ngrok alternative. Expose local ports to the internet with automatic HTTPS via your own VPS.

```
$ pgrok myapp 4000

  pgrok

  Tunnel:    https://myapp.yourdomain.com
  Forwards:  → localhost:4000

  Press Ctrl+C to stop the tunnel.
```

## How it works

```
Browser → https://myapp.yourdomain.com
       → DNS wildcard A record → VPS
       → Caddy terminates TLS (on-demand cert via Let's Encrypt)
       → Caddy reverse proxies to SSH tunnel port
       → SSH tunnel forwards to your Mac
       → localhost:4000
```

**Caddy** on the VPS handles HTTPS with on-demand TLS — certs are auto-provisioned per subdomain via Let's Encrypt (HTTP-01 challenge). No DNS provider API tokens needed.
**SSH reverse tunnels** carry traffic — no extra tunnel software.
A small **Python script** on the server dynamically configures Caddy routes when tunnels connect/disconnect.

## Quick Start

### 1. Server (on your VPS)

```bash
git clone <this-repo> ~/pgrok
cd ~/pgrok
sudo ./setup.sh server
```

The setup script will interactively ask for:
- Your domain name
- Your Mac's SSH public key

It then automatically:
- Starts stock Caddy via Docker (no custom build needed)
- Installs the `pgrok-ask` cert validation service
- Installs the `pgrok-tunnel` route controller
- Creates a `pgrok` SSH user with your key
- Configures sshd for secure tunnel forwarding

### 2. DNS (Vercel dashboard)

The setup script will print the exact DNS record to add. It's just one wildcard A record:

| Type | Name | Value |
|------|------|-------|
| A    | *    | `<your-vps-ip>` |

This works with Vercel, Cloudflare, or any DNS provider. Just point `*.yourdomain.com` at your VPS.

### 3. Client (on your Mac)

```bash
cd ~/pgrok  # or wherever you cloned it
./setup.sh client
```

The setup script will ask for:
- VPS hostname/IP
- Your domain
- SSH user (defaults to `pgrok`)

It then:
- Writes `~/.pgrok/config` with your settings
- Installs the `pgrok` command to `/usr/local/bin`
- Optionally tests the SSH connection

## Usage

```bash
# Expose a local dev server
pgrok myapp 4000
# → https://myapp.yourdomain.com

# Expose an API
pgrok api 3000
# → https://api.yourdomain.com

# Any subdomain works instantly
pgrok staging 8080
# → https://staging.yourdomain.com
```

Press `Ctrl+C` to stop. The route is cleaned up automatically.

## Project Structure

```
pgrok/
├── setup.sh                  # Interactive installer (server + client)
├── server/
│   ├── Dockerfile            # Stock Caddy image
│   ├── docker-compose.yml    # Caddy container config
│   ├── Caddyfile             # On-demand TLS config
│   ├── .env.example          # Environment variables template
│   ├── pgrok-tunnel          # Server-side tunnel controller (Python)
│   ├── pgrok-ask             # Cert validation endpoint (Python)
│   ├── pgrok-ask.service     # Systemd unit for pgrok-ask
│   └── setup-vps.sh          # Standalone server setup (alternative to setup.sh)
├── client/
│   ├── pgrok                 # CLI script (bash)
│   └── config.example        # Client config template
└── README.md
```

## Prerequisites

**VPS:**
- Docker + Docker Compose
- Python 3
- SSH access (root for setup)
- Ports 80 and 443 open

**Mac:**
- SSH client (built-in)
- SSH key pair (`ssh-keygen` if you don't have one)

**DNS:**
- A wildcard A record `*.yourdomain.com` pointing to your VPS (any DNS provider)

## How SSL Works

1. A request arrives for `myapp.yourdomain.com`
2. Caddy checks with `pgrok-ask` service: "Should I get a cert for this domain?"
3. `pgrok-ask` verifies it matches `*.yourdomain.com` — responds 200
4. Caddy uses HTTP-01 challenge to get a Let's Encrypt cert (automatic, no API tokens)
5. Cert is cached and auto-renewed
6. First request has a brief delay (~2s) for cert provisioning; subsequent requests are instant

## Security

- SSH key authentication only (no passwords)
- Dedicated `pgrok` user with restricted SSH (remote forwarding only)
- Caddy admin API only on localhost (not exposed externally)
- SSH tunnels bind to localhost only (`GatewayPorts no`)
- `pgrok-ask` prevents cert abuse — only allows certs for `*.yourdomain.com`

## Configuration

### Client (`~/.pgrok/config`)

Generated by `setup.sh client`. You can edit it manually:

```bash
PGROK_HOST=your-vps-ip
PGROK_DOMAIN=yourdomain.com
PGROK_USER=pgrok
PGROK_SSH_KEY=~/.ssh/id_ed25519
```

### Server

Files live in `/opt/pgrok/` after setup:

| File | Purpose |
|------|---------|
| `Caddyfile` | On-demand TLS config |
| `docker-compose.yml` | Caddy container |
| `Dockerfile` | Stock Caddy image |

Scripts at `/usr/local/bin/`:

| Script | Purpose |
|--------|---------|
| `pgrok-tunnel` | Manages Caddy routes (invoked by SSH) |
| `pgrok-ask` | Validates cert requests (systemd service) |

## Troubleshooting

**"SSH connection failed" during client setup:**
- Verify the server setup completed successfully
- Check that your SSH public key matches what was provided during server setup
- Try manually: `ssh pgrok@your-vps-ip`

**"No active tunnel on {host}" in browser:**
- The tunnel isn't running. Start it with `pgrok <subdomain> <port>`
- If it was running, the SSH connection may have dropped

**SSL certificate errors:**
- On first access, Caddy provisions the cert (~2 seconds). Retry after a moment.
- Check Caddy logs: `docker compose logs caddy` in `/opt/pgrok`
- Verify the `pgrok-ask` service is running: `systemctl status pgrok-ask`
- Make sure ports 80 and 443 are open on the VPS firewall

**"Port not yet reachable" warning:**
- Usually harmless — SSH tunnel takes a moment to establish
- If traffic doesn't work, check your local service is running

## Limitations

- Single user (personal tool, not multi-tenant)
- No automatic reconnection (restart `pgrok` if connection drops)
- Stale routes possible on abrupt disconnection (self-heal on next connect to same subdomain)
- First request to a new subdomain has ~2s delay for cert provisioning

## Future Ideas

- Go/Rust CLI with auto-reconnect
- `pgrok list` — show active tunnels
- `pgrok --auth user:pass` — basic auth on endpoints
- Cleanup cron for stale routes
