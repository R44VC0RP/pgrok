# pgrok

Personal ngrok alternative. Expose local ports to the internet with automatic HTTPS via your own VPS.

```
$ pgrok myapp 4000

  pgrok

  Tunnel:    https://myapp.yourdomain.com
  Forwards:  → localhost:4000

  Press Ctrl+C to stop the tunnel.
```

## How it works

```
Browser → https://myapp.yourdomain.com
       → DNS wildcard A record → VPS
       → Caddy terminates TLS (wildcard cert)
       → Caddy reverse proxies to SSH tunnel port
       → SSH tunnel forwards to your Mac
       → localhost:4000
```

**Caddy** on the VPS handles HTTPS with a wildcard certificate (Let's Encrypt + Vercel DNS).
**SSH reverse tunnels** carry traffic — no extra tunnel software.
A small **Python script** on the server dynamically configures Caddy routes when tunnels connect/disconnect.

## Quick Start

### 1. Server (on your VPS)

```bash
git clone <this-repo> ~/pgrok
cd ~/pgrok
sudo ./setup.sh server
```

The setup script will interactively ask for:
- Your domain name
- Vercel API token (for wildcard SSL)
- Your Mac's SSH public key

It then automatically:
- Builds a custom Caddy Docker image with Vercel DNS support
- Generates the Caddyfile with your domain
- Creates a `pgrok` SSH user with your key
- Configures sshd for secure tunnel forwarding
- Starts Caddy via Docker Compose

### 2. DNS (Vercel dashboard)

The setup script will print the exact DNS record to add. It's just one wildcard A record:

| Type | Name | Value |
|------|------|-------|
| A    | *    | `<your-vps-ip>` |

### 3. Client (on your Mac)

```bash
cd ~/pgrok  # or wherever you cloned it
./setup.sh client
```

The setup script will ask for:
- VPS hostname/IP
- Your domain
- SSH user (defaults to `pgrok`)

It then:
- Writes `~/.pgrok/config` with your settings
- Installs the `pgrok` command to `/usr/local/bin`
- Optionally tests the SSH connection

## Usage

```bash
# Expose a local dev server
pgrok myapp 4000
# → https://myapp.yourdomain.com

# Expose an API
pgrok api 3000
# → https://api.yourdomain.com

# Any subdomain works instantly
pgrok staging 8080
# → https://staging.yourdomain.com
```

Press `Ctrl+C` to stop. The route is cleaned up automatically.

## Project Structure

```
pgrok/
├── setup.sh                  # Interactive installer (server + client)
├── server/
│   ├── Dockerfile            # Custom Caddy with Vercel DNS module
│   ├── docker-compose.yml    # Caddy container config
│   ├── Caddyfile             # Template (setup.sh generates the real one)
│   ├── .env.example          # Environment variables template
│   ├── pgrok-tunnel          # Server-side tunnel controller (Python)
│   └── setup-vps.sh          # Standalone server setup (alternative to setup.sh)
├── client/
│   ├── pgrok                 # CLI script (bash)
│   └── config.example        # Client config template
└── README.md
```

## Prerequisites

**VPS:**
- Docker + Docker Compose
- Python 3
- SSH access (root for setup)

**Mac:**
- SSH client (built-in)
- SSH key pair (`ssh-keygen` if you don't have one)

**DNS:**
- Domain with DNS managed by Vercel (for wildcard SSL)

## How SSL Works

1. Caddy uses the DNS-01 challenge via Vercel's API to prove domain ownership
2. Let's Encrypt issues a single wildcard certificate for `*.yourdomain.com`
3. Auto-renews every ~60 days
4. Every tunnel subdomain gets HTTPS instantly — no per-tunnel cert provisioning

## Security

- SSH key authentication only (no passwords)
- Dedicated `pgrok` user with restricted SSH (remote forwarding only)
- Caddy admin API only on localhost (not exposed externally)
- SSH tunnels bind to localhost only (`GatewayPorts no`)

## Configuration

### Client (`~/.pgrok/config`)

Generated by `setup.sh client`. You can edit it manually:

```bash
PGROK_HOST=your-vps-ip
PGROK_DOMAIN=yourdomain.com
PGROK_USER=pgrok
PGROK_SSH_KEY=~/.ssh/id_ed25519
```

### Server

Files live in `/opt/pgrok/` after setup:

| File | Purpose |
|------|---------|
| `.env` | Vercel API token |
| `Caddyfile` | Wildcard domain config |
| `docker-compose.yml` | Caddy container |
| `Dockerfile` | Custom Caddy build |

The tunnel script is at `/usr/local/bin/pgrok-tunnel`.

## Troubleshooting

**"SSH connection failed" during client setup:**
- Verify the server setup completed successfully
- Check that your SSH public key matches what was provided during server setup
- Try manually: `ssh pgrok@your-vps-ip`

**"No active tunnel on {host}" in browser:**
- The tunnel isn't running. Start it with `pgrok <subdomain> <port>`
- If it was running, the SSH connection may have dropped

**SSL certificate errors:**
- Caddy may still be provisioning the wildcard cert (takes a minute on first start)
- Check Caddy logs: `docker compose logs caddy` in `/opt/pgrok`
- Verify Vercel API token has DNS permissions

**"Port not yet reachable" warning:**
- Usually harmless — SSH tunnel takes a moment to establish
- If traffic doesn't work, check your local service is running

## Limitations

- Single user (personal tool, not multi-tenant)
- No automatic reconnection (restart `pgrok` if connection drops)
- Stale routes possible on abrupt disconnection (self-heal on next connect to same subdomain)

## Future Ideas

- Go/Rust CLI with auto-reconnect
- `pgrok list` — show active tunnels
- `pgrok --auth user:pass` — basic auth on endpoints
- Cleanup cron for stale routes
